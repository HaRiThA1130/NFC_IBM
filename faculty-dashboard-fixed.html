<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faculty Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            margin: 0 auto;
        }
    </style>
</head>

<body>

    <div class="container mt-4">
        <h2>Faculty Dashboard</h2>
        <button id="logoutBtn" class="btn btn-danger float-end">Logout</button>
        <br><br>

        <div class="row text-center">
            <div class="col-md-4">
                <h4>Total Students</h4>
                <p id="totalStudents">0</p>
            </div>
            <div class="col-md-4">
                <h4>Present Today</h4>
                <p id="presentToday">0</p>
            </div>
            <div class="col-md-4">
                <h4>Attendance Rate</h4>
                <p id="attendanceRate">0%</p>
            </div>
        </div>

        <canvas id="attendanceChart" height="100"></canvas>

        <h3 class="mt-4">Attendance Table</h3>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Profile</th>
                    <th>Registration Number</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="attendanceTableBody"></tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDz8GmEYaZPymSTowedSKUsj_naF7JTfXw",
            authDomain: "kare-attendance-system-9fe72.firebaseapp.com",
            projectId: "kare-attendance-system-9fe72",
            storageBucket: "kare-attendance-system-9fe72.appspot.com",
            messagingSenderId: "148380211452",
            appId: "1:148380211452:web:72ba700a4ca285f74b1f79",
            measurementId: "G-26LT6RJ37X"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Check if user is authenticated
        auth.onAuthStateChanged((user) => {
            if (!user) {
                // User not signed in, redirect to login
                window.location.href = 'faculty-login.html';
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = 'faculty-login.html';
            });
        });

        async function loadAttendance() {
            const attendanceRef = collection(db, "attendance");
            const snap = await getDocs(attendanceRef);

            const today = new Date().toLocaleDateString();
            let table = document.getElementById("attendanceTableBody");
            table.innerHTML = "";

            let present = 0;
            let hourly = Array(24).fill(0);

            snap.forEach(doc => {
                let data = doc.data();
                let ts = data.timestamp;

                let dateObj = ts?.toDate ? ts.toDate() : new Date(ts);
                if (dateObj.toLocaleDateString() !== today) return;

                present++;
                hourly[dateObj.getHours()]++;

                let row = table.insertRow();

                // Create avatar cell with first letter
                const identifier = data.registrationNumber || data.nfc_id || "-";
                const avatarCell = row.insertCell(0);
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'avatar';
                avatarDiv.textContent = identifier.charAt(0).toUpperCase();
                avatarCell.appendChild(avatarDiv);

                // Add other cells
                row.insertCell(1).textContent = identifier;
                row.insertCell(2).textContent = dateObj.toLocaleDateString();
                row.insertCell(3).textContent = dateObj.toLocaleTimeString();
                row.insertCell(4).textContent = data.status || (data.verification_status === "id_match" ? "Present" : "Proxy");
            });

            let total = present + 5;
            document.getElementById("totalStudents").textContent = total;
            document.getElementById("presentToday").textContent = present;
            document.getElementById("attendanceRate").textContent = total ? Math.round((present / total) * 100) + "%" : "0%";

            const ctx = document.getElementById("attendanceChart");
            new Chart(ctx, {
                type: "line",
                data: {
                    labels: [...Array(24).keys()],
                    datasets: [{
                        label: "Attendance by Hour",
                        data: hourly,
                        tension: 0.2
                    }]
                }
            });
        }

        loadAttendance();
    </script>

</body>

</html>